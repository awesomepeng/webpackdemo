{"version":3,"sources":["../../../src/intrinsics/node/contextify.js"],"names":["realm","intrinsicName","obj","intrinsics","ObjectPrototype","runInDebugContextImpl","code","createErrorThrowCompletion","Error","makeContextImpl","isContextImpl","false","ContextifyScriptInternal","constructor","ast","ContextifyScriptConstructor","context","args","argLength","newTarget","proto","ContextifyScriptPrototype","ToString","options","filename","getFilenameArg","lineOffset","getLineOffsetArg","columnOffset","getColumnOffsetArg","displayErrors","getDisplayErrorsArg","cachedDataBuf","getCachedData","produceCachedData","getProduceCachedData","resolvedOptions","undefined","intrinsicConstructor","JSON","stringify","self","length","Set","true","transform","e","decorateErrorStack","$InternalSlot","runInDebugContext","makeContext","isContext","ContextifyScript","runInThisContext","timeout","getTimeoutArg","breakOnSigint","getBreakOnSigintArg","evalMachine","runInContext","sandbox","completion","error","value","errorData","$ErrorData","errorLocation","locationData","stackDecorated","stack","lines","sourceCode","split","line","loc","arrow","repeat","column","decoratedStack","TypeError","ToInteger","RangeError","ToBoolean","defaultFilename","Uint8Array","$ViewedArrayBuffer","$ArrayBufferData","defaultLineOffset","defaultColumnOffset","script","environment","$GlobalEnv","previousContext","getRunningContext","suspend","createExecutionContext","lexicalEnvironment","variableEnvironment","pushContext","result","evaluateCompletion","popContext","onDestroyScope","resume","defineNativeMethod","DefinePropertyOrThrow","writable","enumerable","configurable","patchedCode","replace","transformedCode","plugins","retainLines"],"mappings":"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","file":"contextify.js","sourcesContent":["/**\n * Copyright (c) 2017-present, Facebook, Inc.\n * All rights reserved.\n *\n * This source code is licensed under the BSD-style license found in the\n * LICENSE file in the root directory of this source tree. An additional grant\n * of patent rights can be found in the PATENTS file in the same directory.\n */\n\n/* @flow */\n\nimport invariant from \"../../invariant.js\";\nimport { Realm } from \"../../realm.js\";\nimport { AbruptCompletion, ThrowCompletion } from \"../../completions.js\";\nimport {\n  Value,\n  ConcreteValue,\n  BooleanValue,\n  EmptyValue,\n  NativeFunctionValue,\n  ObjectValue,\n  StringValue,\n  UndefinedValue,\n} from \"../../values/index.js\";\nimport { Get, GetFunctionRealm } from \"../../methods/index.js\";\nimport { Properties, To } from \"../../singletons.js\";\nimport parse from \"../../utils/parse.js\";\nimport type { BabelNodeFile } from \"babel-types\";\n\n// TODO: This creates a strong dependency on babel and its transforms even\n// outside of devDependencies which is unfortunate. Get rid of this once classes\n// and destructuring is fully implemented.\nimport { transform as babelTransform } from \"babel-core\";\n\n// Hook for transpiling\nfunction transform(code: string, filename: string): string {\n  let patchedCode = code.replace(\n    // Work around the fact that Babel classes can't extend natives.\n    /class FastBuffer extends Uint8Array {\\s+constructor\\(arg1, arg2, arg3\\) {\\s+super\\(arg1, arg2, arg3\\);\\s+}\\s+}/g,\n    \"function FastBuffer(arg1, arg2, arg3) {\\n\" +\n      \"  var self = new Uint8Array(arg1, arg2, arg3);\\n\" +\n      \"  Object.setPrototypeOf(self, FastBuffer.prototype);\\n\" +\n      \"  return self;\\n\" +\n      \"}; Object.setPrototypeOf(FastBuffer, Uint8Array); Object.setPrototypeOf(FastBuffer.prototype, Uint8Array.prototype);\"\n  );\n  let transformedCode = babelTransform(patchedCode, {\n    plugins: [\n      // Prepack doesn't support classes or destructuring yet.\n      \"transform-es2015-classes\",\n      \"transform-es2015-destructuring\",\n      \"transform-es2015-parameters\",\n    ],\n    retainLines: true,\n  });\n  return transformedCode.code;\n}\n\nexport default function(realm: Realm): ObjectValue {\n  let intrinsicName = 'process.binding(\"contextify\")';\n  let obj = new ObjectValue(realm, realm.intrinsics.ObjectPrototype, intrinsicName);\n\n  // Contextify\n\n  function runInDebugContextImpl(code) {\n    // TODO: Make this an abstract result.\n    throw realm.createErrorThrowCompletion(\n      realm.intrinsics.Error,\n      \"The V8 debugger is not available from within Prepack.\"\n    );\n  }\n\n  function makeContextImpl() {\n    // TODO: Allow sub-realms to be created and restored.\n    throw realm.createErrorThrowCompletion(realm.intrinsics.Error, \"makeContext is not yet implemented in Prepack.\");\n  }\n\n  function isContextImpl() {\n    // TODO: We don't have a way to create contexts so this is always false.\n    return realm.intrinsics.false;\n  }\n\n  // ContextifyScript\n\n  class ContextifyScriptInternal {\n    ast: BabelNodeFile;\n    constructor(ast: BabelNodeFile) {\n      this.ast = ast;\n    }\n  }\n\n  function ContextifyScriptConstructor(context, args, argLength, newTarget) {\n    if (!newTarget) {\n      throw realm.createErrorThrowCompletion(realm.intrinsics.Error, \"Must call vm.Script as a constructor.\");\n    }\n    let proto = Get(realm, newTarget, \"prototype\");\n    if (!(proto instanceof ObjectValue)) {\n      realm = GetFunctionRealm(realm, newTarget);\n      proto = ContextifyScriptPrototype;\n    }\n\n    invariant(args[0] instanceof ConcreteValue);\n    let code = To.ToString(realm, args[0]);\n\n    let options = args[1];\n    let filename = getFilenameArg(options);\n    let lineOffset = getLineOffsetArg(options);\n    let columnOffset = getColumnOffsetArg(options);\n    let displayErrors = getDisplayErrorsArg(options);\n    let cachedDataBuf = getCachedData(options);\n    let produceCachedData = getProduceCachedData(options);\n\n    let resolvedOptions = {\n      filename: filename,\n      lineOffset: lineOffset,\n      columnOffset: columnOffset,\n      displayErrors: displayErrors,\n      cachedDataBuf: undefined, // Not serializable.\n      produceCachedData: produceCachedData,\n    };\n\n    let intrinsicConstructor = `new (${intrinsicName}).ContextifyScript(${JSON.stringify(code)}, ${JSON.stringify(\n      resolvedOptions\n    )})`;\n\n    let self = new ObjectValue(realm, proto, intrinsicConstructor);\n\n    if (cachedDataBuf.length) {\n      Properties.Set(realm, obj, \"cachedDataRejected\", realm.intrinsics.true, true);\n    }\n\n    if (produceCachedData) {\n      Properties.Set(realm, obj, \"cachedDataProduced\", realm.intrinsics.false, true);\n    }\n\n    let ast;\n    try {\n      // TODO: Somehow pass columnOffset to Babylon.\n      ast = parse(realm, transform(code, filename), filename, \"script\", 1 + lineOffset);\n    } catch (e) {\n      if (displayErrors && e instanceof ThrowCompletion) {\n        decorateErrorStack(e);\n      }\n      throw e;\n    }\n    // TODO: Pick up source map files and automatically fix up source locations.\n\n    (self: any).$InternalSlot = new ContextifyScriptInternal(ast);\n\n    return self;\n  }\n\n  let runInDebugContext = new NativeFunctionValue(\n    realm,\n    `${intrinsicName}.runInDebugContext`,\n    \"runInDebugContext\",\n    0,\n    runInDebugContextImpl\n  );\n  Properties.Set(realm, obj, \"runInDebugContext\", runInDebugContext, true);\n\n  let makeContext = new NativeFunctionValue(realm, `${intrinsicName}.makeContext`, \"makeContext\", 0, makeContextImpl);\n  Properties.Set(realm, obj, \"makeContext\", makeContext, true);\n\n  let isContext = new NativeFunctionValue(realm, `${intrinsicName}.isContext`, \"isContext\", 0, isContextImpl);\n  Properties.Set(realm, obj, \"isContext\", isContext, true);\n\n  let ContextifyScript = new NativeFunctionValue(\n    realm,\n    `${intrinsicName}.ContextifyScript`,\n    \"ContextifyScript\",\n    0,\n    ContextifyScriptConstructor,\n    true\n  );\n  Properties.Set(realm, obj, \"ContextifyScript\", ContextifyScript, true);\n\n  // ContextifyScript.prototype\n\n  function runInThisContext(self, args) {\n    let timeout = getTimeoutArg(args[0]);\n    let displayErrors = getDisplayErrorsArg(args[0]);\n    let breakOnSigint = getBreakOnSigintArg(args[0]);\n    return evalMachine(self, timeout, displayErrors, breakOnSigint);\n  }\n\n  function runInContext(self, [sandbox, options]) {\n    throw realm.createErrorThrowCompletion(\n      realm.intrinsics.Error,\n      \"Cannot run in arbitrary contexts within Prepack yet.\"\n    );\n  }\n\n  function decorateErrorStack(completion: AbruptCompletion): void {\n    let error = completion.value;\n    if (!(error instanceof ObjectValue)) {\n      return;\n    }\n\n    let errorData = error.$ErrorData;\n    if (!errorData) {\n      return;\n    }\n    let errorLocation = errorData.locationData;\n    if (!errorLocation || errorLocation.stackDecorated) {\n      return;\n    }\n\n    let stack = Get(realm, error, \"stack\");\n    if (!(stack instanceof StringValue)) {\n      return;\n    }\n\n    let lines = errorLocation.sourceCode.split(/\\r?\\n/);\n    let line = lines[errorLocation.loc.line - 1] || \"\";\n    let arrow = \" \".repeat(errorLocation.loc.column) + \"^\";\n    let decoratedStack = `${errorLocation.filename}:${errorLocation.loc.line}\\n${line}\\n${arrow}\\n${stack.value}`;\n    Properties.Set(realm, error, \"stack\", new StringValue(realm, decoratedStack), false);\n\n    errorLocation.stackDecorated = true;\n  }\n\n  function getBreakOnSigintArg(options: Value): boolean {\n    if (options instanceof UndefinedValue || options instanceof StringValue) {\n      return false;\n    }\n    if (!(options instanceof ObjectValue)) {\n      throw realm.createErrorThrowCompletion(realm.intrinsics.TypeError, \"options must be an object\");\n    }\n\n    let value = Get(realm, options, \"breakOnSigint\");\n    invariant(value instanceof ConcreteValue);\n    return value instanceof BooleanValue && value.value;\n  }\n\n  function getTimeoutArg(options: Value): number {\n    if (options instanceof UndefinedValue || options instanceof StringValue) {\n      return -1;\n    }\n    if (!(options instanceof ObjectValue)) {\n      throw realm.createErrorThrowCompletion(realm.intrinsics.TypeError, \"options must be an object\");\n    }\n\n    let value = Get(realm, options, \"timeout\");\n    invariant(value instanceof ConcreteValue);\n    if (value instanceof UndefinedValue) {\n      return -1;\n    }\n    let timeout = To.ToInteger(realm, value);\n\n    if (timeout <= 0) {\n      throw realm.createErrorThrowCompletion(realm.intrinsics.RangeError, \"timeout must be a positive number\");\n    }\n\n    return timeout;\n  }\n\n  function getDisplayErrorsArg(options: Value): boolean {\n    if (options instanceof UndefinedValue || options instanceof StringValue) {\n      return true;\n    }\n    if (!(options instanceof ObjectValue)) {\n      throw realm.createErrorThrowCompletion(realm.intrinsics.TypeError, \"options must be an object\");\n    }\n\n    let value = Get(realm, options, \"displayErrors\");\n    invariant(value instanceof ConcreteValue);\n    if (value instanceof UndefinedValue) {\n      return true;\n    }\n    return To.ToBoolean(realm, value);\n  }\n\n  function getFilenameArg(options: Value): string {\n    const defaultFilename = \"evalmachine.<anonymous>\";\n    if (options instanceof UndefinedValue) {\n      return defaultFilename;\n    }\n    if (options instanceof StringValue) {\n      return options.value;\n    }\n    if (!(options instanceof ObjectValue)) {\n      throw realm.createErrorThrowCompletion(realm.intrinsics.TypeError, \"options must be an object\");\n    }\n\n    let value = Get(realm, options, \"filename\");\n    invariant(value instanceof ConcreteValue);\n    if (value instanceof UndefinedValue) {\n      return defaultFilename;\n    }\n    return To.ToString(realm, value);\n  }\n\n  function getCachedData(options: Value): Uint8Array {\n    if (!(options instanceof ObjectValue)) {\n      return new Uint8Array(0);\n    }\n\n    let value = Get(realm, options, \"cachedData\");\n    invariant(value instanceof ConcreteValue);\n    if (value instanceof UndefinedValue) {\n      return new Uint8Array(0);\n    }\n\n    if (\n      !(value instanceof ObjectValue) ||\n      !value.$ViewedArrayBuffer ||\n      !(value.$ViewedArrayBuffer.$ArrayBufferData instanceof Uint8Array)\n    ) {\n      throw realm.createErrorThrowCompletion(\n        realm.intrinsics.TypeError,\n        \"options.cachedData must be a Buffer instance\"\n      );\n    }\n\n    return value.$ViewedArrayBuffer.$ArrayBufferData;\n  }\n\n  function getProduceCachedData(options: Value): boolean {\n    if (!(options instanceof ObjectValue)) {\n      return false;\n    }\n\n    let value = Get(realm, options, \"produceCachedData\");\n    invariant(value instanceof ConcreteValue);\n    return value instanceof BooleanValue && value.value;\n  }\n\n  function getLineOffsetArg(options: Value): number {\n    const defaultLineOffset = 0;\n    if (!(options instanceof ObjectValue)) {\n      return defaultLineOffset;\n    }\n    let value = Get(realm, options, \"lineOffset\");\n    invariant(value instanceof ConcreteValue);\n    return value instanceof UndefinedValue ? defaultLineOffset : To.ToInteger(realm, value);\n  }\n\n  function getColumnOffsetArg(options: Value): number {\n    const defaultColumnOffset = 0;\n    if (!(options instanceof ObjectValue)) {\n      return defaultColumnOffset;\n    }\n    let value = Get(realm, options, \"columnOffset\");\n    invariant(value instanceof ConcreteValue);\n    return value instanceof UndefinedValue ? defaultColumnOffset : To.ToInteger(realm, value);\n  }\n\n  function evalMachine(self: Value, timeout: number, displayErrors: boolean, breakOnSigint: boolean): Value {\n    if (!(self instanceof ObjectValue) || !((self: any).$InternalSlot instanceof ContextifyScriptInternal)) {\n      throw realm.createErrorThrowCompletion(\n        realm.intrinsics.Error,\n        \"Script methods can only be called on script instances.\"\n      );\n    }\n    let script = ((self: any).$InternalSlot: ContextifyScriptInternal);\n\n    let environment = realm.$GlobalEnv;\n\n    let previousContext = realm.getRunningContext();\n    previousContext.suspend();\n\n    let context = realm.createExecutionContext();\n    context.lexicalEnvironment = environment;\n    context.variableEnvironment = environment;\n    context.realm = realm;\n\n    realm.pushContext(context);\n\n    let result;\n    try {\n      result = environment.evaluateCompletion(script.ast, false);\n    } finally {\n      context.suspend();\n      realm.popContext(context);\n      invariant(context.lexicalEnvironment === realm.$GlobalEnv);\n      realm.onDestroyScope(context.lexicalEnvironment);\n    }\n    invariant(realm.getRunningContext() === previousContext);\n    previousContext.resume();\n\n    if (result instanceof EmptyValue) {\n      return realm.intrinsics.undefined;\n    } else if (result instanceof Value) {\n      return result;\n    } else {\n      invariant(result instanceof AbruptCompletion);\n      if (displayErrors) {\n        decorateErrorStack(result);\n      }\n      throw result;\n    }\n  }\n\n  let ContextifyScriptPrototype = new ObjectValue(\n    realm,\n    realm.intrinsics.ObjectPrototype,\n    `${intrinsicName}.ContextifyScript.prototype`\n  );\n\n  ContextifyScriptPrototype.defineNativeMethod(\"runInContext\", 2, runInContext);\n  ContextifyScriptPrototype.defineNativeMethod(\"runInThisContext\", 1, runInThisContext);\n\n  Properties.DefinePropertyOrThrow(realm, ContextifyScript, \"prototype\", {\n    value: ContextifyScriptPrototype,\n    writable: true,\n    enumerable: false,\n    configurable: false,\n  });\n\n  Properties.DefinePropertyOrThrow(realm, ContextifyScriptPrototype, \"constructor\", {\n    value: ContextifyScript,\n    writable: true,\n    enumerable: false,\n    configurable: true,\n  });\n\n  return obj;\n}\n"]}