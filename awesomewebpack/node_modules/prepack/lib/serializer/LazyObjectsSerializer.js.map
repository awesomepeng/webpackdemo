{"version":3,"sources":["../../src/serializer/LazyObjectsSerializer.js"],"names":["t","LAZY_OBJECTS_SERIALIZER_BODY_TYPE","LazyObjectsSerializer","constructor","realm","logger","modules","residualHeapValueIdentifiers","residualHeapInspector","residualValues","residualFunctionInstances","residualClassMethodInstances","residualFunctionInfos","options","referencedDeclaredValues","additionalFunctionValuesAndEffects","additionalFunctionValueInfos","declarativeEnvironmentRecordsBindings","referentializer","generatorDAG","conditionalFeasibility","additionalGeneratorRoots","_lazyObjectIdSeed","_valueLazyIds","Map","_lazyObjectInitializers","_callbackLazyObjectParam","identifier","_options","lazyObjectsRuntime","_lazyObjectJSRuntimeName","_initializationCallbackName","_getValueLazyId","obj","_serializeLazyObjectInitializer","emitIntegrityCommand","initializerBody","type","parentBody","undefined","entries","done","oldBody","emitter","beginEmitting","_emitObjectProperties","getBody","endEmitting","_serializeLazyObjectInitializerSwitchCase","initializer","caseBody","concat","breakStatement","lazyId","switchCase","numericLiteral","_serializeInitializationCallback","body","switchCases","push","throwStatement","newExpression","stringLiteral","selector","switchStatement","params","initializerCallbackFunction","functionExpression","blockStatement","variableDeclaration","variableDeclarator","_serializeRegisterInitializationCallback","expressionStatement","callExpression","memberExpression","_serializeCreateLazyObject","_isEmittingIntoLazyObjectInitializerBody","objLazyBody","get","isCurrentBodyOffspringOf","getSerializeObjectIdentifier","val","serializeValueRawObject","skipPrototype","temporalAlias","set","postGeneratorSerialization","size","prelude"],"mappings":"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","file":"LazyObjectsSerializer.js","sourcesContent":["/**\n * Copyright (c) 2017-present, Facebook, Inc.\n * All rights reserved.\n *\n * This source code is licensed under the BSD-style license found in the\n * LICENSE file in the root directory of this source tree. An additional grant\n * of patent rights can be found in the PATENTS file in the same directory.\n */\n\n/* @flow strict-local */\n\nimport { Realm } from \"../realm.js\";\nimport { AbstractValue, FunctionValue, Value, ObjectValue } from \"../values/index.js\";\nimport * as t from \"babel-types\";\nimport type {\n  BabelNodeExpression,\n  BabelNodeStatement,\n  BabelNodeIdentifier,\n  BabelNodeBlockStatement,\n  BabelNodeSwitchCase,\n} from \"babel-types\";\nimport type {\n  SerializedBody,\n  FunctionInfo,\n  FunctionInstance,\n  AdditionalFunctionInfo,\n  ClassMethodInstance,\n  AdditionalFunctionEffects,\n  ResidualFunctionBinding,\n} from \"./types.js\";\nimport type { SerializerOptions } from \"../options.js\";\nimport invariant from \"../invariant.js\";\nimport { Logger } from \"../utils/logger.js\";\nimport { Modules } from \"../utils/modules.js\";\nimport { HeapInspector } from \"../utils/HeapInspector.js\";\nimport type { Scope } from \"./ResidualHeapVisitor.js\";\nimport { ResidualHeapValueIdentifiers } from \"./ResidualHeapValueIdentifiers.js\";\nimport { ResidualHeapSerializer } from \"./ResidualHeapSerializer.js\";\nimport { getOrDefault } from \"./utils.js\";\nimport type { DeclarativeEnvironmentRecord } from \"../environment.js\";\nimport type { Referentializer } from \"./Referentializer.js\";\nimport { Generator } from \"../utils/generator.js\";\nimport { GeneratorDAG } from \"./GeneratorDAG.js\";\n\nconst LAZY_OBJECTS_SERIALIZER_BODY_TYPE = \"LazyObjectInitializer\";\n\n/**\n * Serialize objects in lazy mode by leveraging the JS runtime that support this feature.\n * Objects are serialized into two parts:\n * 1. All lazy objects are created via lightweight LazyObjectsRuntime.createLazyObject() call.\n * 2. Lazy objects' property assignments are delayed in a callback function which is registered with the runtime.\n *    lazy objects runtime will execute this callback to hydrate the lazy objects.\n *\n * Currently only the raw objects are taking part in the lazy objects feature.\n * TODO: support for other objects, like array, regex etc...\n */\nexport class LazyObjectsSerializer extends ResidualHeapSerializer {\n  constructor(\n    realm: Realm,\n    logger: Logger,\n    modules: Modules,\n    residualHeapValueIdentifiers: ResidualHeapValueIdentifiers,\n    residualHeapInspector: HeapInspector,\n    residualValues: Map<Value, Set<Scope>>,\n    residualFunctionInstances: Map<FunctionValue, FunctionInstance>,\n    residualClassMethodInstances: Map<FunctionValue, ClassMethodInstance>,\n    residualFunctionInfos: Map<BabelNodeBlockStatement, FunctionInfo>,\n    options: SerializerOptions,\n    referencedDeclaredValues: Map<Value, void | FunctionValue>,\n    additionalFunctionValuesAndEffects: Map<FunctionValue, AdditionalFunctionEffects> | void,\n    additionalFunctionValueInfos: Map<FunctionValue, AdditionalFunctionInfo>,\n    declarativeEnvironmentRecordsBindings: Map<DeclarativeEnvironmentRecord, Map<string, ResidualFunctionBinding>>,\n    referentializer: Referentializer,\n    generatorDAG: GeneratorDAG,\n    conditionalFeasibility: Map<AbstractValue, { t: boolean, f: boolean }>,\n    additionalGeneratorRoots: Map<Generator, Set<ObjectValue>>\n  ) {\n    super(\n      realm,\n      logger,\n      modules,\n      residualHeapValueIdentifiers,\n      residualHeapInspector,\n      residualValues,\n      residualFunctionInstances,\n      residualClassMethodInstances,\n      residualFunctionInfos,\n      options,\n      referencedDeclaredValues,\n      additionalFunctionValuesAndEffects,\n      additionalFunctionValueInfos,\n      declarativeEnvironmentRecordsBindings,\n      referentializer,\n      generatorDAG,\n      conditionalFeasibility,\n      additionalGeneratorRoots\n    );\n    this._lazyObjectIdSeed = 1;\n    this._valueLazyIds = new Map();\n    this._lazyObjectInitializers = new Map();\n    this._callbackLazyObjectParam = t.identifier(\"obj\");\n    invariant(this._options.lazyObjectsRuntime != null);\n    this._lazyObjectJSRuntimeName = t.identifier(this._options.lazyObjectsRuntime);\n    this._initializationCallbackName = t.identifier(\"__initializerCallback\");\n  }\n\n  _lazyObjectIdSeed: number;\n  _valueLazyIds: Map<ObjectValue, number>;\n  // Holds object's lazy initializer bodies.\n  // These bodies will be combined into a well-known callback after generator serialization is done and registered with the runtime.\n  _lazyObjectInitializers: Map<ObjectValue, SerializedBody>;\n\n  _lazyObjectJSRuntimeName: BabelNodeIdentifier;\n  _callbackLazyObjectParam: BabelNodeIdentifier;\n  _initializationCallbackName: BabelNodeIdentifier;\n\n  _getValueLazyId(obj: ObjectValue): number {\n    return getOrDefault(this._valueLazyIds, obj, () => this._lazyObjectIdSeed++);\n  }\n\n  // TODO: change to use _getTarget() to get the lazy objects initializer body.\n  _serializeLazyObjectInitializer(\n    obj: ObjectValue,\n    emitIntegrityCommand: void | (SerializedBody => void)\n  ): SerializedBody {\n    const initializerBody = {\n      type: LAZY_OBJECTS_SERIALIZER_BODY_TYPE,\n      parentBody: undefined,\n      entries: [],\n      done: false,\n    };\n    let oldBody = this.emitter.beginEmitting(LAZY_OBJECTS_SERIALIZER_BODY_TYPE, initializerBody);\n    this._emitObjectProperties(obj);\n    if (emitIntegrityCommand !== undefined) emitIntegrityCommand(this.emitter.getBody());\n    this.emitter.endEmitting(LAZY_OBJECTS_SERIALIZER_BODY_TYPE, oldBody);\n    return initializerBody;\n  }\n\n  _serializeLazyObjectInitializerSwitchCase(obj: ObjectValue, initializer: SerializedBody): BabelNodeSwitchCase {\n    // TODO: only serialize this switch case if the initializer(property assignment) is not empty.\n    const caseBody = initializer.entries.concat(t.breakStatement());\n    const lazyId = this._getValueLazyId(obj);\n    return t.switchCase(t.numericLiteral(lazyId), caseBody);\n  }\n\n  _serializeInitializationCallback(): BabelNodeStatement {\n    const body = [];\n\n    const switchCases = [];\n    for (const [obj, initializer] of this._lazyObjectInitializers) {\n      switchCases.push(this._serializeLazyObjectInitializerSwitchCase(obj, initializer));\n    }\n    // Default case.\n    switchCases.push(\n      t.switchCase(null, [\n        t.throwStatement(t.newExpression(t.identifier(\"Error\"), [t.stringLiteral(\"Unknown lazy id\")])),\n      ])\n    );\n\n    const selector = t.identifier(\"id\");\n    body.push(t.switchStatement(selector, switchCases));\n\n    const params = [this._callbackLazyObjectParam, selector];\n    const initializerCallbackFunction = t.functionExpression(null, params, t.blockStatement(body));\n    // TODO: use NameGenerator.\n    return t.variableDeclaration(\"var\", [\n      t.variableDeclarator(this._initializationCallbackName, initializerCallbackFunction),\n    ]);\n  }\n\n  _serializeRegisterInitializationCallback(): BabelNodeStatement {\n    return t.expressionStatement(\n      t.callExpression(t.memberExpression(this._lazyObjectJSRuntimeName, t.identifier(\"setLazyObjectInitializer\")), [\n        this._initializationCallbackName,\n      ])\n    );\n  }\n\n  _serializeCreateLazyObject(obj: ObjectValue): BabelNodeExpression {\n    const lazyId = this._getValueLazyId(obj);\n    return t.callExpression(\n      t.memberExpression(this._lazyObjectJSRuntimeName, t.identifier(\"createLazyObject\"), /*computed*/ false),\n      [t.numericLiteral(lazyId)]\n    );\n  }\n\n  /**\n   * Check if the object currently being emitted is lazy object(inside _lazyObjectInitializers map) and\n   * that its emitting body is the offspring of this lazy object's initializer body.\n   * This is needed because for \"lazy1.p = lazy2\" case,\n   * we need to replace \"lazy1\" with \"obj\" but not for \"lazy2\".\n   * The offspring checking is needed because object may be emitting in a \"ConditionalAssignmentBranch\" of\n   * lazy object's initializer body.\n   */\n  _isEmittingIntoLazyObjectInitializerBody(obj: ObjectValue): boolean {\n    const objLazyBody = this._lazyObjectInitializers.get(obj);\n    return objLazyBody !== undefined && this.emitter.isCurrentBodyOffspringOf(objLazyBody);\n  }\n\n  // Override default behavior.\n  // Inside lazy objects callback, the lazy object identifier needs to be replaced with the\n  // parameter passed from the runtime.\n  getSerializeObjectIdentifier(val: Value): BabelNodeIdentifier {\n    return val instanceof ObjectValue && this._isEmittingIntoLazyObjectInitializerBody(val)\n      ? this._callbackLazyObjectParam\n      : super.getSerializeObjectIdentifier(val);\n  }\n\n  // Override default serializer with lazy mode.\n  serializeValueRawObject(\n    obj: ObjectValue,\n    skipPrototype: boolean,\n    emitIntegrityCommand: void | (SerializedBody => void)\n  ): BabelNodeExpression {\n    if (obj.temporalAlias !== undefined) return super.serializeValueRawObject(obj, skipPrototype, emitIntegrityCommand);\n    this._lazyObjectInitializers.set(obj, this._serializeLazyObjectInitializer(obj, emitIntegrityCommand));\n    return this._serializeCreateLazyObject(obj);\n  }\n\n  // Override.\n  // Serialize the initialization callback and its registration in prelude if there are object being lazied.\n  postGeneratorSerialization(): void {\n    if (this._lazyObjectInitializers.size > 0) {\n      // Insert initialization callback at the end of prelude code.\n      this.prelude.push(this._serializeInitializationCallback());\n      this.prelude.push(this._serializeRegisterInitializationCallback());\n    }\n  }\n}\n"]}