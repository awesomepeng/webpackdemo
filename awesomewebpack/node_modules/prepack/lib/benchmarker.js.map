{"version":3,"sources":["../src/benchmarker.js"],"names":["chalk","require","jsdom","zlib","fs","vm","getTime","stamp","process","hrtime","exec","_code","compatibility","code","sandbox","setTimeout","setInterval","console","error","log","s","beforeCode","afterCode","window","defaultView","document","navigator","location","start","script","Script","cachedDataProduced","executedStart","runInNewContext","executedEnd","raw","length","gzip","gzipSync","executed","compiled","total","line","type","moreOut","compareStats","undefined","stats","wrapTime","key","wrap","ms","toFixed","wrapSize","b","kilobytes","Math","round","format","positive","negative","before","after","factor","green","red","out","bold","dump","name","min","outputFilename","inverse","beforeStats","Date","now","realm","serialize","serializer","sources","filePath","fileContents","serialized","init","exit","isValidOutputFilename","filename","writeFileSync","args","Array","from","argv","splice","inputFilename","arg","shift","startsWith","input","readFileSync"],"mappings":"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","file":"benchmarker.js","sourcesContent":["/**\n * Copyright (c) 2017-present, Facebook, Inc.\n * All rights reserved.\n *\n * This source code is licensed under the BSD-style license found in the\n * LICENSE file in the root directory of this source tree. An additional grant\n * of patent rights can be found in the PATENTS file in the same directory.\n */\n\n/* @flow strict-local */\n\nimport type { Compatibility } from \"./options.js\";\nimport Serializer from \"./serializer/index.js\";\nimport construct_realm from \"./construct_realm.js\";\nimport initializeGlobals from \"./globals.js\";\nimport invariant from \"./invariant.js\";\n\nlet chalk = require(\"chalk\");\nlet jsdom = require(\"jsdom\");\nlet zlib = require(\"zlib\");\nlet fs = require(\"fs\");\nlet vm = require(\"vm\");\n\ntype Sandbox = {\n  setTimeout: (func: () => mixed, timeout?: number, ...args?: Array<mixed>) => TimeoutID,\n  setInterval: (func: () => mixed, timeout?: number, ...args?: Array<mixed>) => IntervalID,\n  console: {\n    error: (msg: string | {}) => void,\n    log: (msg: string | {}) => void,\n  },\n  window?: {},\n  document?: {},\n  navigator?: {},\n  location?: {},\n};\n\nfunction getTime() {\n  let stamp = process.hrtime();\n  return (stamp[0] * 1e9 + stamp[1]) / 1e6;\n}\n\nfunction exec(_code: string, compatibility: Compatibility) {\n  let code = _code;\n  let sandbox: Sandbox = {\n    setTimeout: setTimeout,\n    setInterval: setInterval,\n    console: {\n      error() {},\n      log(s) {\n        console.log(s);\n      },\n    },\n  };\n\n  let beforeCode = \"var global = this; \";\n  let afterCode = `// At the end of the script, Node tries to clone the 'this' Object (global) which involves executing all getters on it.\n// To avoid executing any more code (which could affect timing), we just set all globals to undefined (hoping that doesn't take too long).\nObject.getOwnPropertyNames(global).forEach(function(name){ if (name !== \"Object\" && name !== \"global\") global[name] = undefined; });`;\n\n  if (compatibility === \"browser\") {\n    beforeCode += \"var window = this; var self = this; \";\n    let window = jsdom.jsdom({}).defaultView;\n    sandbox.window = window;\n    sandbox.document = window.document;\n    sandbox.navigator = window.navigator;\n    sandbox.location = window.location;\n  }\n  if (compatibility === \"jsc-600-1-4-17\") {\n    beforeCode +=\n      \"delete global.clearInterval; delete global.clearImmediate; delete global.clearTimeout; delete global.setImmediate; delete Object.assign;\";\n  }\n\n  code = `${beforeCode} ${code}; // keep newline here as code may end with comment\n${afterCode}`;\n\n  let start = getTime();\n  let script = new vm.Script(code, { cachedDataProduced: false });\n  let executedStart = getTime();\n  script.runInNewContext(sandbox);\n  let executedEnd = getTime();\n\n  return {\n    raw: code.length,\n    gzip: zlib.gzipSync(code).length,\n    executed: executedEnd - executedStart,\n    compiled: executedStart - start,\n    total: executedEnd - start,\n  };\n}\n\nfunction line(type, code, compatibility: Compatibility, moreOut = {}, compareStats = undefined) {\n  let stats = exec(code, compatibility);\n\n  function wrapTime(key) {\n    return wrap(key, ms => `${ms.toFixed(2)}ms`, \"faster\", \"slower\");\n  }\n\n  function wrapSize(key) {\n    return wrap(\n      key,\n      function(b) {\n        let kilobytes = Math.round(b / 1000);\n        if (kilobytes > 1000) {\n          return `${(kilobytes / 1000).toFixed(2)}MB`;\n        } else {\n          return `${kilobytes}KB`;\n        }\n      },\n      \"smaller\",\n      \"bigger\"\n    );\n  }\n\n  function wrap(key, format, positive, negative) {\n    if (compareStats) {\n      let before = compareStats[key];\n      let after = stats[key];\n      let factor;\n\n      if (after < before) {\n        factor = chalk.green(`${(before / after).toFixed(2)}x ${positive}`);\n      } else {\n        factor = chalk.red(`${(after / before).toFixed(2)}x ${negative}`);\n      }\n\n      return `${format(after)} ${factor}`;\n    } else {\n      return format(stats[key]);\n    }\n  }\n\n  let out = {\n    \"VM Total Time\": wrapTime(\"total\"),\n    \"VM Compile Time\": wrapTime(\"compiled\"),\n    \"VM Execution Time\": wrapTime(\"executed\"),\n    \"Raw Code Size\": wrapSize(\"raw\"),\n    \"Gzip Code Size\": wrapSize(\"gzip\"),\n    ...moreOut,\n  };\n\n  console.log(chalk.bold(type));\n\n  for (let key in out) {\n    console.log(`  ${chalk.bold(key)} ${out[key]}`);\n  }\n\n  return stats;\n}\n\nfunction dump(\n  name: string,\n  raw: string,\n  min: string = raw,\n  compatibility?: \"browser\" | \"jsc-600-1-4-17\" = \"browser\",\n  outputFilename?: string\n) {\n  console.log(chalk.inverse(name));\n  let beforeStats = line(\"Before\", min, compatibility);\n\n  let start = Date.now();\n  let realm = construct_realm({ serialize: true, compatibility });\n  initializeGlobals(realm);\n  let serializer = new Serializer(realm);\n  let sources = [{ filePath: name, fileContents: raw }];\n  let serialized = serializer.init(sources);\n  if (!serialized) {\n    process.exit(1);\n    invariant(false);\n  }\n  let code = serialized.code;\n  let total = Date.now() - start;\n\n  const isValidOutputFilename = outputFilename !== undefined && outputFilename !== \"\";\n  if (code.length >= 1000 || isValidOutputFilename) {\n    let filename = outputFilename !== undefined ? outputFilename : name + \"-processed.js\";\n    console.log(`Prepacked source code written to ${filename}.`);\n    fs.writeFileSync(filename, code);\n  }\n\n  line(\n    \"After\",\n    code,\n    compatibility,\n    {\n      \"Prepack Compile Time\": `${total}ms`,\n    },\n    beforeStats\n  );\n\n  if (code.length <= 1000 && !isValidOutputFilename) {\n    console.log(\"+++++++++++++++++ Prepacked source code\");\n    console.log(code);\n    console.log(\"=================\");\n  }\n}\n\nlet args = Array.from(process.argv);\nargs.splice(0, 2);\nlet inputFilename;\nlet outputFilename;\nlet compatibility;\nwhile (args.length) {\n  let arg = args[0];\n  args.shift();\n  if (arg === \"--out\") {\n    arg = args[0];\n    args.shift();\n    outputFilename = arg;\n  } else if (arg === \"--compatibility\") {\n    arg = args[0];\n    args.shift();\n    if (arg !== \"jsc-600-1-4-17\") {\n      console.error(`Unsupported compatibility: ${arg}`);\n      process.exit(1);\n    } else {\n      compatibility = arg;\n    }\n  } else if (arg === \"--help\") {\n    console.log(\"Usage: benchmarker.js [ --out output.js ] [ --compatibility jsc ] [ -- | input.js ]\");\n  } else if (!arg.startsWith(\"--\")) {\n    inputFilename = arg;\n  } else {\n    console.error(`Unknown option: ${arg}`);\n    process.exit(1);\n  }\n}\n\nif (!inputFilename) {\n  console.error(\"Missing input file.\");\n  process.exit(1);\n} else {\n  let input = fs.readFileSync(inputFilename, \"utf8\");\n  dump(inputFilename, input, input, compatibility, outputFilename);\n}\n\n//dump(\"helloWorld\", \"function hello() { return 'hello'; } function world() { return 'world'; } s = hello() + ' ' + world();\");\n\n//dump(\"regex\", \"regex = /Facebook/i;\");\n\n//dump(\"test\", \"try { new WeakSet().delete.call(0, {}); } catch (e) {console.log(e);}\");\n//dump(\"test\", \"e = 'abcdef'.substr(1,2); \");\n//dump(\"test\", \"var s = 'Promise'; e = s[0];\");\n//dump(\"test\", \"foo = function() { return [,0]; };\");\n\n//dump(\"simple\", \"var foo = 5 * 5; var bar = [2, 3, 'yes']; var foo2 = null; var bar2 = undefined;\");\n//dump(\"simple2\", \"function Foo() {} Foo.prototype.wow = function () {};\");\n\n//dump(\"Date.now\", \"Date.now\");\n//dump(\"Date.now\", \"this.foo = Date.now();\");\n//dump(\"object recursion\", \"var obj = { yes: 'no' }; obj.bar = obj; var foo = [obj]; obj.foobar = foo;\");\n//dump(\"intrinsic union\", \"var assign = Object.assign || function () {}; var obj = assign({ foo: 1 }, { bar: 2 });\");\n\n/*dump(\n  \"fbsdk\",\n  fs.readFileSync(__dirname + \"/../assets/fbsdk.js\", \"utf8\")\n);*/\n\n/*dump(\n  \"react\",\n  fs.readFileSync(__dirname + \"/../assets/react.js\", \"utf8\"),\n  fs.readFileSync(__dirname + \"/../assets/react.min.js\", \"utf8\")\n);*/\n\n/*dump(\n  \"immutable\",\n  fs.readFileSync(__dirname + \"/../assets/immutable.js\", \"utf8\"),\n  fs.readFileSync(__dirname + \"/../assets/immutable.min.js\", \"utf8\")\n);*/\n\n/*dump(\n  \"react-native-bundle\",\n  fs.readFileSync(__dirname + \"/../../examples/react-native-bundle/bundle.js\", \"utf8\")\n);*/\n\n/*dump(\n  \"lodash\",\n  fs.readFileSync(require.resolve(\"lodash/lodash.js\"), \"utf8\"),\n  fs.readFileSync(require.resolve(\"lodash/lodash.min.js\"), \"utf8\")\n);*/\n\n/*dump(\n  \"underscore\",\n  fs.readFileSync(require.resolve(\"underscore\"), \"utf8\"),\n  fs.readFileSync(require.resolve(\"underscore/underscore-min\"), \"utf8\")\n);\n*/\n\n/*dump(\n  \"ember\",\n  fs.readFileSync(\"ember.prod.js\", \"utf8\")\n);\n\ndump(\n  \"jquery\",\n  fs.readFileSync(require.resolve(\"jquery/dist/jquery.js\"), \"utf8\"),\n  fs.readFileSync(require.resolve(\"jquery/dist/jquery.min.js\"), \"utf8\")\n);\n\ndump(\n  \"scrollin\",\n  fs.readFileSync(\"scrollin.js\", \"utf8\")\n);\n*/\n"]}